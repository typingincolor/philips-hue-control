openapi: 3.0.0
info:
  title: Philips Hue Control API
  version: 2.0.0
  description: |2-

          A simplified, client-friendly API for controlling Philips Hue lights.

          **Features:**
          - Pre-computed RGB colors and CSS shadows
          - Unified dashboard endpoint (1 call instead of 4-6)
          - Room hierarchy already built
          - Session-based authentication
          - Demo mode for testing without a real bridge
          - Settings and weather API
          - Real-time updates via WebSocket

          **Authentication Methods:**
          1. **Session Token**: Get a session token from `POST /api/v1/auth/session`, then use `Authorization: Bearer <token>` header
          2. **Demo Mode**: Add `X-Demo-Mode: true` header to use mock data (no bridge required)

          **Demo Mode:**
          Try the API without a Hue Bridge by adding `X-Demo-Mode: true` header to any request.
          - Returns mock data (2 rooms, 6 lights, 4 scenes, 2 zones)
          - State changes persist in memory (reset on server restart)
          - WebSocket: authenticate with `{ type: 'auth', demoMode: true }`

          **Multi-Client Support:**
          When one client pairs with a bridge, credentials are stored server-side. Other clients can then connect without re-pairing:
          1. First client: `POST /api/v1/auth/pair` â†’ `POST /api/v1/auth/session`
          2. Subsequent clients: `POST /api/v1/auth/connect` (no pairing needed!)
          3. Check availability: `GET /api/v1/auth/bridge-status?bridgeIp=...`

          **WebSocket API:**
          Connect to `/api/v1/ws` for real-time updates. Authenticate with:
          - Session: `{ type: 'auth', sessionToken: '<token>' }`
          - Demo: `{ type: 'auth', demoMode: true }`

  contact:
    name: API Support
  license:
    name: MIT
servers:
  - url: http://localhost:3001/api/v1
    description: Development server
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Session Token
      description: Session token from POST /api/v1/auth/session
    DemoMode:
      type: apiKey
      in: header
      name: X-Demo-Mode
      description: Set to "true" to use demo mode (no bridge required)
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: resource_not_found
        message:
          type: string
          example: The light 'abc123' was not found
        suggestion:
          type: string
          example: Check the light ID or refresh the dashboard to get current lights
    Light:
      type: object
      properties:
        id:
          type: string
          example: abc-123-def
        name:
          type: string
          example: Living Room 1
        'on':
          type: boolean
          example: true
        brightness:
          type: number
          minimum: 0
          maximum: 100
          example: 80
        color:
          type: string
          nullable: true
          example: rgb(255, 180, 120)
          description: Pre-computed CSS color string (ready to use!)
        shadow:
          type: string
          nullable: true
          example: 0 0 20px rgba(255, 180, 120, 0.4)
          description: Pre-computed CSS box-shadow (ready to use!)
        colorSource:
          type: string
          enum:
            - xy
            - temperature
            - fallback
            - null
          example: xy
    Room:
      type: object
      properties:
        id:
          type: string
          example: room-uuid
        name:
          type: string
          example: Living Room
        stats:
          type: object
          properties:
            lightsOnCount:
              type: integer
              example: 2
            totalLights:
              type: integer
              example: 4
            averageBrightness:
              type: number
              example: 75.5
        lights:
          type: array
          items:
            $ref: '#/components/schemas/Light'
        scenes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
    Zone:
      type: object
      description: A Hue zone (group of lights that can span multiple rooms)
      properties:
        id:
          type: string
          example: zone-uuid
        name:
          type: string
          example: Downstairs
        stats:
          type: object
          properties:
            lightsOnCount:
              type: integer
              example: 2
            totalLights:
              type: integer
              example: 4
            averageBrightness:
              type: number
              example: 75.5
        lights:
          type: array
          items:
            $ref: '#/components/schemas/Light'
        scenes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
    MotionZone:
      type: object
      description: A MotionAware zone with motion detection status
      properties:
        id:
          type: string
        name:
          type: string
          example: Hallway MotionAware
        motionDetected:
          type: boolean
          example: false
        enabled:
          type: boolean
          example: true
        reachable:
          type: boolean
          example: true
        lastChanged:
          type: string
          format: date-time
          example: '2025-12-23T10:30:00Z'
    Location:
      type: object
      description: Geographic location for weather
      properties:
        lat:
          type: number
          example: 51.5074
          description: Latitude
        lon:
          type: number
          example: -0.1278
          description: Longitude
        name:
          type: string
          example: London
          description: Location name
      required:
        - lat
        - lon
    Settings:
      type: object
      description: User settings for the session
      properties:
        location:
          oneOf:
            - $ref: '#/components/schemas/Location'
            - type: 'null'
          description: Location for weather (null if not set)
        units:
          type: string
          enum:
            - celsius
            - fahrenheit
          example: celsius
          description: Temperature unit preference
    WeatherCurrent:
      type: object
      description: Current weather conditions
      properties:
        temperature:
          type: number
          example: 15
          description: Temperature in configured units
        condition:
          type: string
          example: Partly cloudy
        humidity:
          type: number
          example: 65
          description: Humidity percentage
        windSpeed:
          type: number
          example: 12
          description: Wind speed in km/h
        icon:
          type: string
          example: partly-cloudy
          description: Weather icon identifier
    WeatherForecast:
      type: object
      description: Daily weather forecast
      properties:
        date:
          type: string
          format: date
          example: '2025-01-15'
        high:
          type: number
          example: 18
          description: High temperature
        low:
          type: number
          example: 10
          description: Low temperature
        condition:
          type: string
          example: Sunny
        icon:
          type: string
          example: sunny
    Weather:
      type: object
      description: Weather data with current conditions and forecast
      properties:
        current:
          $ref: '#/components/schemas/WeatherCurrent'
        forecast:
          type: array
          items:
            $ref: '#/components/schemas/WeatherForecast'
          description: 5-day forecast
        location:
          type: string
          example: London
          description: Location name
        units:
          type: string
          enum:
            - celsius
            - fahrenheit
          example: celsius
    Automation:
      type: object
      description: A Hue automation (behavior_instance)
      properties:
        id:
          type: string
          example: behavior-uuid-123
        name:
          type: string
          example: Good Morning
        type:
          type: string
          example: behavior_instance
        scriptId:
          type: string
          example: wake_up
          description: The type of automation script
        enabled:
          type: boolean
          example: true
        triggerTime:
          type: object
          nullable: true
          properties:
            hour:
              type: integer
              example: 7
            minute:
              type: integer
              example: 0
        recurrenceDays:
          type: array
          nullable: true
          items:
            type: string
          example: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        targets:
          type: object
          nullable: true
          properties:
            groups:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  type:
                    type: string
                  name:
                    type: string
            lights:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
        styleInfo:
          type: object
          nullable: true
          properties:
            style:
              type: string
              example: sunrise
            fadeOutMinutes:
              type: integer
              example: 30
            endState:
              type: string
              example: turn_off
paths:
  /auth/pair:
    post:
      summary: Pair with a Hue Bridge
      description: Initial pairing with a Hue Bridge. User must press the link button on the bridge before calling this endpoint.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bridgeIp
              properties:
                bridgeIp:
                  type: string
                  example: 192.168.1.100
                  description: Your Hue Bridge IP address
                appName:
                  type: string
                  example: hue_control_app
                  description: Application name for the Hue Bridge (optional)
      responses:
        '200':
          description: Pairing successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  username:
                    type: string
                    example: KZLwQGOGUMwtFMpYMeRqA9gzSuYoRtRgVThntanx
                    description: Generated Hue API key
        '400':
          description: Link button not pressed or invalid bridge IP
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: link button not pressed
                  type:
                    type: integer
                    example: 101
        '504':
          description: Bridge connection timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/connect:
    post:
      summary: Connect using stored credentials
      description: Connect to a bridge using server-side stored credentials. Use this when another client has already paired with the bridge. No pairing needed!
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bridgeIp
              properties:
                bridgeIp:
                  type: string
                  example: 192.168.1.100
                  description: Your Hue Bridge IP address
      responses:
        '200':
          description: Connected successfully using stored credentials
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionToken:
                    type: string
                    example: hue_sess_abc123...
                  expiresIn:
                    type: integer
                    example: 86400
                  bridgeIp:
                    type: string
                    example: 192.168.1.100
        '401':
          description: Stored credentials are no longer valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Stored credentials are no longer valid. Pairing required.
                  requiresPairing:
                    type: boolean
                    example: true
        '404':
          description: No stored credentials for this bridge
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: No stored credentials for this bridge. Pairing required.
                  requiresPairing:
                    type: boolean
                    example: true
  /auth/bridge-status:
    get:
      summary: Check if bridge has stored credentials
      description: Check whether the server has stored credentials for a specific bridge IP
      tags:
        - Authentication
      parameters:
        - name: bridgeIp
          in: query
          required: true
          schema:
            type: string
          description: Bridge IP to check
          example: 192.168.1.100
      responses:
        '200':
          description: Bridge status
          content:
            application/json:
              schema:
                type: object
                properties:
                  bridgeIp:
                    type: string
                    example: 192.168.1.100
                  hasCredentials:
                    type: boolean
                    example: true
        '400':
          description: Missing bridgeIp parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/session:
    post:
      summary: Create a new session
      description: Connect to your Hue Bridge and get a session token for subsequent requests
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bridgeIp
                - username
              properties:
                bridgeIp:
                  type: string
                  example: 192.168.1.100
                  description: Your Hue Bridge IP address
                username:
                  type: string
                  example: abc123def456
                  description: Your Hue API username/key
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionToken:
                    type: string
                    example: hue_sess_abc123...
                  expiresIn:
                    type: integer
                    example: 86400
                    description: Session expires in seconds (24 hours)
                  bridgeIp:
                    type: string
                    example: 192.168.1.100
        '400':
          description: Missing credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Cannot connect to bridge
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: Get current session info
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Session info
          content:
            application/json:
              schema:
                type: object
                properties:
                  bridgeIp:
                    type: string
                    example: 192.168.1.100
                  active:
                    type: boolean
                    example: true
        '401':
          description: Invalid or expired session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Revoke session (logout)
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Session revoked
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Session revoked
  /auth/refresh:
    post:
      summary: Refresh session token
      description: Extend the expiration of your current session by getting a new token
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Session refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionToken:
                    type: string
                    example: hue_sess_new123...
                  expiresIn:
                    type: integer
                    example: 86400
                  bridgeIp:
                    type: string
                    example: 192.168.1.100
        '401':
          description: Invalid or expired session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/stats:
    get:
      summary: Get session statistics
      description: Get session statistics for monitoring and debugging
      tags:
        - Authentication
      responses:
        '200':
          description: Session statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  activeSessions:
                    type: integer
                    example: 5
                  oldestSession:
                    type: integer
                    example: 3600000
                    description: Age in milliseconds
                  newestSession:
                    type: integer
                    example: 300000
                    description: Age in milliseconds
  /dashboard:
    get:
      summary: Get unified dashboard data
      description: Returns all data needed to render the dashboard in a single request with pre-computed colors and stats
      tags:
        - Dashboard
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: object
                    properties:
                      totalLights:
                        type: integer
                        example: 12
                      lightsOn:
                        type: integer
                        example: 5
                      roomCount:
                        type: integer
                        example: 4
                      sceneCount:
                        type: integer
                        example: 8
                  rooms:
                    type: array
                    items:
                      $ref: '#/components/schemas/Room'
                  zones:
                    type: array
                    description: Hue zones (groups of lights that can span multiple rooms)
                    items:
                      $ref: '#/components/schemas/Zone'
                  motionZones:
                    type: array
                    description: MotionAware zones with motion detection status
                    items:
                      $ref: '#/components/schemas/MotionZone'
        '401':
          description: Missing or invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /lights/{id}:
    put:
      summary: Update a light
      tags:
        - Lights
      security:
        - BearerAuth: []
        - DemoMode: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Light UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                'on':
                  type: boolean
                  example: true
                brightness:
                  type: number
                  minimum: 0
                  maximum: 100
                  example: 80
      responses:
        '200':
          description: Light updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  light:
                    $ref: '#/components/schemas/Light'
        '404':
          description: Light not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /rooms/{id}/lights:
    put:
      summary: Update all lights in a room
      description: Toggle all lights in a room on or off
      tags:
        - Rooms
      security:
        - BearerAuth: []
        - DemoMode: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Room UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                'on':
                  type: boolean
                  example: true
      responses:
        '200':
          description: Lights updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  updatedLights:
                    type: array
                    items:
                      $ref: '#/components/schemas/Light'
        '404':
          description: Room not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /zones/{id}/lights:
    put:
      summary: Update all lights in a zone
      description: Toggle all lights in a zone on or off
      tags:
        - Zones
      security:
        - BearerAuth: []
        - DemoMode: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Zone UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                'on':
                  type: boolean
                  example: true
      responses:
        '200':
          description: Lights updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  updatedLights:
                    type: array
                    items:
                      $ref: '#/components/schemas/Light'
        '404':
          description: Zone not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /scenes/{id}/activate:
    post:
      summary: Activate a scene
      description: Activate a Hue scene by its UUID
      tags:
        - Scenes
      security:
        - BearerAuth: []
        - DemoMode: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Scene UUID
      responses:
        '200':
          description: Scene activated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  affectedLights:
                    type: array
                    items:
                      $ref: '#/components/schemas/Light'
        '404':
          description: Scene not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /motion-zones:
    get:
      summary: Get motion zones
      description: Returns all MotionAware zones with parsed motion status
      tags:
        - Motion
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Motion zones
          content:
            application/json:
              schema:
                type: object
                properties:
                  zones:
                    type: array
                    items:
                      $ref: '#/components/schemas/MotionZone'
  /settings:
    get:
      summary: Get current settings
      description: Returns the current settings for this session (location and units)
      tags:
        - Settings
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Current settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
        '401':
          description: Missing or invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      summary: Update settings
      description: Update all settings (location and/or units)
      tags:
        - Settings
      security:
        - BearerAuth: []
        - DemoMode: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                location:
                  $ref: '#/components/schemas/Location'
                units:
                  type: string
                  enum:
                    - celsius
                    - fahrenheit
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
        '400':
          description: Invalid settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /settings/location:
    put:
      summary: Update location
      description: Update just the location setting
      tags:
        - Settings
      security:
        - BearerAuth: []
        - DemoMode: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Location'
      responses:
        '200':
          description: Location updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
        '400':
          description: Invalid location
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Clear location
      description: Remove the stored location
      tags:
        - Settings
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Location cleared
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
  /weather:
    get:
      summary: Get weather data
      description: Returns current weather and 5-day forecast for the stored location. Returns 404 if no location is set.
      tags:
        - Weather
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Weather data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Weather'
        '404':
          description: No location set
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: No location set. Use PUT /settings/location first.
  /automations:
    get:
      summary: Get all automations
      description: Returns all Hue automations (behavior_instances) with trigger times, recurrence, and target info
      tags:
        - Automations
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: List of automations
          content:
            application/json:
              schema:
                type: object
                properties:
                  automations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Automation'
        '401':
          description: Missing or invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /automations/{id}/trigger:
    post:
      summary: Trigger an automation
      description: Manually trigger a Hue automation (behavior_instance)
      tags:
        - Automations
      security:
        - BearerAuth: []
        - DemoMode: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Automation UUID
      responses:
        '200':
          description: Automation triggered
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '404':
          description: Automation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /hive/connect:
    post:
      summary: Connect to Hive
      description: Authenticate with UK Hive heating system API
      tags:
        - Hive
      security:
        - BearerAuth: []
        - DemoMode: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  description: Hive account email
                password:
                  type: string
                  description: Hive account password
      responses:
        '200':
          description: Connected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '400':
          description: Missing credentials
        '401':
          description: Invalid credentials
  /hive/disconnect:
    post:
      summary: Disconnect from Hive
      description: Clear Hive session
      tags:
        - Hive
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Disconnected
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
  /hive/connection:
    get:
      summary: Get Hive connection status
      description: Check if connected to Hive (in demo mode or with real credentials)
      tags:
        - Hive
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Connection status
          content:
            application/json:
              schema:
                type: object
                properties:
                  connected:
                    type: boolean
                    example: true
  /hive/status:
    get:
      summary: Get Hive status
      description: Get current thermostat and hot water status
      tags:
        - Hive
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: Hive status
          content:
            application/json:
              schema:
                type: object
                properties:
                  heating:
                    type: object
                    properties:
                      currentTemperature:
                        type: number
                        example: 19.5
                      targetTemperature:
                        type: number
                        example: 21
                      isHeating:
                        type: boolean
                        example: true
                      mode:
                        type: string
                        example: schedule
                  hotWater:
                    type: object
                    properties:
                      isOn:
                        type: boolean
                        example: false
                      mode:
                        type: string
                        example: schedule
  /hive/schedules:
    get:
      summary: Get Hive schedules
      description: Get heating and hot water schedules
      tags:
        - Hive
      security:
        - BearerAuth: []
        - DemoMode: []
      responses:
        '200':
          description: List of schedules
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    type:
                      type: string
                      enum:
                        - heating
                        - hotWater
                    time:
                      type: string
                      example: '06:00'
                    days:
                      type: array
                      items:
                        type: string
tags:
  - name: Authentication
    description: Session management
  - name: Dashboard
    description: Unified dashboard data
  - name: Lights
    description: Individual light control
  - name: Rooms
    description: Room-level control
  - name: Zones
    description: Zone-level control (groups spanning multiple rooms)
  - name: Scenes
    description: Scene activation
  - name: Motion
    description: MotionAware zones
  - name: Automations
    description: Hue automations (behavior_instances) - scheduled lighting routines
  - name: Settings
    description: User settings (location and units)
  - name: Weather
    description: Weather data for the stored location
  - name: Hive
    description: UK Hive heating system integration
